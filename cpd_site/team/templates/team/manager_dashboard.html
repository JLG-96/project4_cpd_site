{% extends "team/base.html" %}
{% load custom_filters %}

{% block content %}
<nav class="standard-nav">
    <ul>
        <li><a href="{% url 'home' %}">Home</a></li>
        <li><a href="{% url 'fixtures' %}">Fixtures</a></li>
        <li><a href="{% url 'results' %}">Results</a></li>
        <li><a href="{% url 'league_table' %}">League Table</a></li>
        {% if request.user.is_authenticated %}
            {% if request.user.profile.role == "manager" %}
                <li><a href="{% url 'manager_dashboard' %}">Manager Dashboard</a></li>
            {% elif request.user.profile.role == "player" %}
                <li><a href="{% url 'player_dashboard' %}">Player Dashboard</a></li>
            {% endif %}
            <li>
                <form action="{% url 'logout' %}" method="post">
                    {% csrf_token %}
                    <button type="submit">Logout</button>
                </form>
            </li>
        {% else %}
            <li><a href="{% url 'login' %}">Login</a></li>
        {% endif %}
    </ul>
</nav>

<div class="dashboard-container">
    <h1>Manager Dashboard</h1>

    <!-- Upcoming Fixtures Section -->
    {% if upcoming_fixtures %}
    <div class="fixtures-container">
        {% for fixture in upcoming_fixtures %}
            <div class="fixture-card">
                <h3>{{ fixture.opponent }}</h3>
                <p class="fixture-date">{{ fixture.date|date:"d/m/Y" }} at {{ fixture.time }}</p>
                <p class="fixture-location">Location: {{ fixture.location }}</p>

                <div class="availability">
                    <details>
                        <summary>Available Players ({{ fixture_availability|get_item:fixture.id|yes_count }})</summary>
                        <ul>
                            {% for player in fixture_availability|get_item:fixture.id %}
                                {% if player.status == "yes" %}
                                    <li>{{ player.player.username }}</li>
                                {% endif %}
                            {% empty %}
                                <li>No players confirmed availability yet.</li>
                            {% endfor %}
                        </ul>
                    </details>

                    <details>
                        <summary>Unavailable Players ({{ fixture_availability|get_item:fixture.id|no_count }})</summary>
                        <ul>
                            {% for player in fixture_availability|get_item:fixture.id %}
                                {% if player.status == "no" %}
                                    <li>{{ player.player.username }}</li>
                                {% endif %}
                            {% empty %}
                                <li>No players set as unavailable yet.</li>
                            {% endfor %}
                        </ul>
                    </details>
                </div>
            </div>
        {% endfor %}
    </div>
    {% else %}
    <p>No upcoming fixtures.</p>
    {% endif %}
    
    <!-- Manager Posts -->
    <div class="dashboard-section">
        <h2>Manager Announcements</h2>
        <form method="post">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit" class="btn-submit">Post</button>
        </form>

        {% for post in posts %}
            <div class="post-card">
                <p><strong>{{ post.manager.username }}</strong> - {{ post.created_at|date:"d/m/Y" }}</p>
                <p>{{ post.content }}</p>
            </div>
        {% empty %}
            <p>No announcements yet.</p>
        {% endfor %}
    </div>
    <!-- Manager Messages Section -->
    <div class="grid-item manager-messages">
        <h2>To the Players</h2>
        <form method="POST">
            {% csrf_token %}
            {{ message_form.as_p }}
            <button type="submit" name="message_submit">Send Message</button>
        </form>

        <h3>Sent Messages</h3>
        {% for message in messages %}
            <div class="message-card">
                <h4>{{ message.title }}</h4>
                <p>{{ message.content }}</p>
                <p class="date"><small>Sent on {{ message.created_at|date:"d/m/Y" }}</small></p>
            </div>
        {% empty %}
            <p>No messages sent yet.</p>
        {% endfor %}
    </div>
</div>
{% endblock %}
